<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="initial-scale=1,maximum-scale=1,user-scalable=no"
    />
    <title>Deutschlandkeks</title>

    <link
      rel="stylesheet"
      href="https://js.arcgis.com/4.28/esri/themes/light/main.css"
    />
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
      html,
      body,
      #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script>
      require([
        "esri/core/Collection",
        "esri/geometry/Point",
        "esri/geometry/SpatialReference",
        "esri/Graphic",
        "esri/layers/GroupLayer",
        "esri/layers/FeatureLayer",
        "esri/layers/GraphicsLayer",
        "esri/layers/MediaLayer",
        "esri/layers/support/ControlPointsGeoreference",
        "esri/layers/support/ImageElement",
        "esri/Map",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/Viewpoint",
        "esri/views/MapView",
        "esri/widgets/BasemapGallery",
        "esri/widgets/Expand",
        "esri/widgets/Search",
        "esri/widgets/LayerList",
        "esri/widgets/Sketch/SketchViewModel",
      ], (
        Collection,
        Point,
        SpatialReference,
        Graphic,
        GroupLayer,
        FeatureLayer,
        GraphicsLayer,
        MediaLayer,
        ControlPointsGeoreference,
        ImageElement,
        Map,
        SimpleLineSymbol,
        SimpleMarkerSymbol,
        Viewpoint,
        MapView,
        BasemapGallery,
        Expand,
        Search,
        LayerList,
        SketchViewModel
      ) => {
        // a function to create a Graphic from a point, color and index
        const createGraphic = (point, color, index) =>
          new Graphic({
            geometry: point,
            symbol: new SimpleMarkerSymbol({
              style: "circle",
              color,
              size: 12,
              outline: new SimpleLineSymbol({
                color: "white",
                width: 1.5,
              }),
            }),
            attributes: { index },
          });

        // a function to update the georeference control points based on the location of graphics
        const updateGeoreference = (graphics, controlPointsGeoreference) => {
          const points = graphics
            .toArray()
            .sort((a, b) => a.attributes.index - b.attributes.index)
            .map((graphic) => graphic.geometry);

          controlPointsGeoreference.controlPoints = points.map(
            (mapPoint, index) => ({
              sourcePoint:
                controlPointsGeoreference.controlPoints[index].sourcePoint,
              mapPoint,
            })
          );
        };

        const map = new Map({
          basemap: {
            portalItem: {
              id: "4f0d421553de4e3197b04ce9ce186a90",
            },
          },
        });

        const spatialReference = new SpatialReference({ wkid: 102100 });
        const view = new MapView({
          container: "viewDiv",
          map,
          extent: {
            spatialReference: spatialReference,
            xmin: -257793.69841675786,
            ymin: 5749516.81728855,
            xmax: 2613792.58019998,
            ymax: 7449476.326350417,
          },
        });
        // view.watch("extent", (e) => console.log(JSON.stringify(e)));

        const search = new Search({ view: view });
        view.ui.add(search, "top-right");

        const ll = new LayerList({ view: view });
        view.ui.add(ll, "bottom-right");

        const basemapGallery = new BasemapGallery({ view: view });
        const bgExpand = new Expand({
          expandIcon: "basemap",
          view: view,
          content: basemapGallery,
        });
        view.ui.add(bgExpand, "top-right");

        // use the SketchViewModel to allow updating the graphics and control points
        const sketch = new SketchViewModel({
          updateOnGraphicClick: true,
          view,
        });
        // sketch.on("update", (u) => {
        //   if (u.state === "complete") {
        //     console.log(JSON.stringify(u.graphics[0].geometry));
        //   }
        // });

        const addDeutschlandkeksMediaLayer = async () => {
          // set view scale constraints
          view.constraints.maxScale = 10000;
          view.constraints.minScale = 100000000;

          // four points representing known map coordinates on the MediaLayer's ImageElement
          const swCornerMapPoint = new Point({
            x: 617278.7279272052,
            y: 5778673.423306355,
            spatialReference,
          });
          const nwCornerMapPoint = new Point({
            x: 574229.6026045051,
            y: 7392534.159204069,
            spatialReference,
          });
          const neCornerMapPoint = new Point({
            x: 1702317.2735420805,
            y: 7484503.281211413,
            spatialReference,
          });
          const seCornerMapPoint = new Point({
            x: 1762978.2664952497,
            y: 5837376.463865069,
            spatialReference,
          });

          // create a GraphicsLayer to show the four points on the Map
          const controlPointsLayer = new GraphicsLayer({
            graphics: [
              createGraphic(swCornerMapPoint, "green", 0),
              createGraphic(nwCornerMapPoint, "purple", 1),
              createGraphic(neCornerMapPoint, "blue", 2),
              createGraphic(seCornerMapPoint, "red", 3),
            ],
            id: "controlPointsLayer",
            title: "Control points"
          });

          // create an array of four control points composed of a sourcePoint, a point
          // on the image element in pixels, and a mapPoint which is the location of the
          // sourcePoint in map space
          const swCornerControlPoint = {
            sourcePoint: { x: 89, y: 1918 },
            mapPoint: swCornerMapPoint,
          };

          const nwCornerControlPoint = {
            sourcePoint: { x: 83, y: 101 },
            mapPoint: nwCornerMapPoint,
          };

          const neCornerControlPoint = {
            sourcePoint: { x: 1508, y: 97 },
            mapPoint: neCornerMapPoint,
          };

          const seCornerControlPoint = {
            sourcePoint: { x: 1517, y: 1906 },
            mapPoint: seCornerMapPoint,
          };

          const controlPoints = [
            swCornerControlPoint,
            nwCornerControlPoint,
            neCornerControlPoint,
            seCornerControlPoint,
          ];

          // georeference for the imageElement using the control points,
          // image width, and image height
          const controlPointsGeoreference = new ControlPointsGeoreference({
            controlPoints,
            width: 1585,
            height: 2048,
          });

          const imageElement = new ImageElement({
            image: "./deutschlandkeks.jpg",
            georeference: controlPointsGeoreference,
          });

          const mediaLayer = new MediaLayer({
            source: [imageElement],
            title: "Deutschlandkeks Media",
            copyright: "Bundesamt für Kartographie und Geodäsie, 2023",
            spatialReference,
          });

          const countryFl = new FeatureLayer({
            portalItem: {
              id: "53a1e68de7e4499cad77c80daba46a94",
            },
            renderer: {
              type: "simple",
              symbol: {
                type: "simple-fill",
                color: [51, 51, 204, 0.9],
                style: "solid",
                outline: {
                  color: "white",
                  width: 1,
                },
              },
            },
            definitionExpression: "COUNTRY='Germany'",
            blendMode: "destination-in",
            listMode: "hide",
            title: "Deutschland",
            effect: "blur(10px) bloom(0.5)"
          });

          const groupLayer = new GroupLayer({
            layers: [mediaLayer, countryFl],
            blendMode: "multiply",
            title: "Deutschlandkeks",
            listMode: "hide-children"
          });

          map.layers.addMany([groupLayer, controlPointsLayer]);

          // use the SketchViewModel to allow updating the graphics and control points
          sketch.layer = controlPointsLayer;

          sketch.on("update", (event) => {
            if (event.toolEventInfo?.type === "move-start") {
              imageElement.opacity = 0.3;
            }
            if (event.toolEventInfo?.type === "move-stop") {
              imageElement.opacity = 0.9;
            }

            updateGeoreference(
              controlPointsLayer.graphics,
              controlPointsGeoreference
            );
          });

          sketch.on("redo", () => {
            updateGeoreference(
              controlPointsLayer.graphics,
              controlPointsGeoreference
            );
          });

          sketch.on("undo", () => {
            updateGeoreference(
              controlPointsLayer.graphics,
              controlPointsGeoreference
            );
          });

          await view.when();
          await mediaLayer.when();
          view.goTo(mediaLayer.fullExtent);
        };

        // when the web page first loads add the Telluride geology map
        addDeutschlandkeksMediaLayer();
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>
