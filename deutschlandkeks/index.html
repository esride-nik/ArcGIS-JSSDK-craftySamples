<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <title>Deutschlandkeks</title>

    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
    <script src="https://js.arcgis.com/4.28/"></script>

    <style>
      html,
      body,
      #viewDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
    <script>
      require([
        "esri/core/Collection",
        "esri/geometry/Point",
        "esri/geometry/SpatialReference",
        "esri/Graphic",
        "esri/layers/GraphicsLayer",
        "esri/layers/MediaLayer",
        "esri/layers/support/ControlPointsGeoreference",
        "esri/layers/support/ImageElement",
        "esri/Map",
        "esri/symbols/SimpleLineSymbol",
        "esri/symbols/SimpleMarkerSymbol",
        "esri/Viewpoint",
        "esri/views/MapView",
        "esri/webmap/Bookmark",
        "esri/widgets/Bookmarks",
        "esri/widgets/Expand",
        "esri/widgets/Sketch/SketchViewModel"
      ], (
        Collection,
        Point,
        SpatialReference,
        Graphic,
        GraphicsLayer,
        MediaLayer,
        ControlPointsGeoreference,
        ImageElement,
        Map,
        SimpleLineSymbol,
        SimpleMarkerSymbol,
        Viewpoint,
        MapView,
        Bookmark,
        Bookmarks,
        Expand,
        SketchViewModel
      ) => {
        // a function to create a Graphic from a point, color and index
        const createGraphic = (point, color, index) =>
          new Graphic({
            geometry: point,
            symbol: new SimpleMarkerSymbol({
              style: "circle",
              color,
              size: 12,
              outline: new SimpleLineSymbol({
                color: "white",
                width: 1.5
              })
            }),
            attributes: { index }
          });

        // a function to update the georeference control points based on the location of graphics
        const updateGeoreference = (graphics, controlPointsGeoreference) => {
          const points = graphics
            .toArray()
            .sort((a, b) => a.attributes.index - b.attributes.index)
            .map((graphic) => graphic.geometry);

          controlPointsGeoreference.controlPoints = points.map((mapPoint, index) => ({
            sourcePoint: controlPointsGeoreference.controlPoints[index].sourcePoint,
            mapPoint
          }));
        };

        // the spatial reference for the Telluride MediaLayer, North American Datum 1927
        const spatialReference = new SpatialReference({ wkid: 4267 });

        const tellurideCenter = new Point({ x: -107.762, y: 37.9375, spatialReference });
        const denverCenter = new Point({ x: -104.98604461997, y: 39.74799276 });

        const map = new Map({ basemap: "topo-vector" });
        const zoom = 12;

        const view = new MapView({
          center: tellurideCenter,
          container: "viewDiv",
          map,
          zoom
        });

        view.watch("camera", (c) => console.log(c))

        // use the SketchViewModel to allow updating the graphics and control points
        const sketch = new SketchViewModel({
          updateOnGraphicClick: true,
          view
        });

        const addDeutschlandkeksMediaLayer = async () => {
          // set view scale constraints
          view.constraints.maxScale = 10000;
          view.constraints.minScale = 1000000;


          // four points representing known map coordinates on the MediaLayer's ImageElement
          const swCornerMapPoint = new Point({ x: -107.875, y: 37.875, spatialReference });
          const nwCornerMapPoint = new Point({ x: -107.875, y: 38, spatialReference });
          const neCornerMapPoint = new Point({ x: -107.75, y: 38, spatialReference });
          const seCornerMapPoint = new Point({ x: -107.75, y: 37.875, spatialReference });

          // create a GraphicsLayer to show the four points on the Map
          const graphicsLayer = new GraphicsLayer({
            graphics: [
              createGraphic(swCornerMapPoint, "green", 0),
              createGraphic(nwCornerMapPoint, "purple", 1),
              createGraphic(neCornerMapPoint, "blue", 2),
              createGraphic(seCornerMapPoint, "red", 3)
            ]
          });

          // create an array of four control points composed of a sourcePoint, a point
          // on the image element in pixels, and a mapPoint which is the location of the
          // sourcePoint in map space
          const swCornerControlPoint = {
            sourcePoint: { x: 89, y: 1918 },
            mapPoint: swCornerMapPoint
          };

          const nwCornerControlPoint = {
            sourcePoint: { x: 83, y: 101 },
            mapPoint: nwCornerMapPoint
          };

          const neCornerControlPoint = {
            sourcePoint: { x: 1508, y: 97 },
            mapPoint: neCornerMapPoint
          };

          const seCornerControlPoint = {
            sourcePoint: { x: 1517, y: 1906 },
            mapPoint: seCornerMapPoint
          };

          const controlPoints = [
            swCornerControlPoint,
            nwCornerControlPoint,
            neCornerControlPoint,
            seCornerControlPoint
          ];


          // georeference for the imageElement using the control points,
          // image width, and image height
          const controlPointsGeoreference = new ControlPointsGeoreference({ controlPoints, width: 1585, height: 2048 });

          const imageElement = new ImageElement({
            image: "./deutschlandkeks/deutschlandkeks.jpg",
            georeference: controlPointsGeoreference
          });

          const mediaLayer = new MediaLayer({
            source: [imageElement],
            title: "Deutschlandkeks",
            copyright: "Bundesamt für Kartographie und Geodäsie, 2023",
            spatialReference
          });


          map.layers.addMany([mediaLayer, graphicsLayer]);


          // use the SketchViewModel to allow updating the graphics and control points
          sketch.layer = graphicsLayer;

          sketch.on("update", (event) => {
            if (event.toolEventInfo?.type === "move-start") {
              imageElement.opacity = 0.3;
            }
            if (event.toolEventInfo?.type === "move-stop") {
              imageElement.opacity = 0.9;
            }

            updateGeoreference(graphicsLayer.graphics, controlPointsGeoreference);
          });

          sketch.on("redo", () => {
            updateGeoreference(graphicsLayer.graphics, controlPointsGeoreference);
          });

          sketch.on("undo", () => {
            updateGeoreference(graphicsLayer.graphics, controlPointsGeoreference);
          });


          await view.when();
          await mediaLayer.when();
          view.goTo(mediaLayer.fullExtent);
        };

        // when the web page first loads add the Telluride geology map
        addDeutschlandkeksMediaLayer();
      });
    </script>
  </head>

  <body>
    <div id="viewDiv"></div>
  </body>
</html>